<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ja.min.js"></script>

<script>
const currentViewMode = "<?= viewMode ?>";
let myModal = null;

document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('msgModal');
  myModal = new bootstrap.Modal(modalEl);

  if (currentViewMode !== 'create') {
    loadTimetable();
  }
});

function showInfoModal(title, message, callback) {
  document.getElementById('msgModalTitle').innerText = title;
  document.getElementById('msgModalBody').innerHTML = message;
  document.getElementById('msgModalCancel').style.display = 'none';
  
  const okBtn = document.getElementById('msgModalOK');
  okBtn.innerText = 'OK';
  okBtn.onclick = function() {
    myModal.hide();
    if (callback) callback();
  };
  
  myModal.show();
}

function showConfirmModal(title, message, onConfirm) {
  document.getElementById('msgModalTitle').innerText = title;
  document.getElementById('msgModalBody').innerHTML = message;
  document.getElementById('msgModalCancel').style.display = 'inline-block';
  
  const okBtn = document.getElementById('msgModalOK');
  okBtn.innerText = '確定する';
  
  const newBtn = okBtn.cloneNode(true);
  okBtn.parentNode.replaceChild(newBtn, okBtn);
  
  newBtn.onclick = function() {
    myModal.hide();
    if (onConfirm) onConfirm();
  };
  
  myModal.show();
}


function addAttendeeRow() {
  const container = document.getElementById('attendees-container');
  const currentRows = container.querySelectorAll('.attendee-row').length;
  
  if (currentRows >= 8) {
    showInfoModal('制限', '出席者はこれ以上追加できません（最大数です）');
    return;
  }

  const div = document.createElement('div');
  div.className = 'row mb-2 attendee-row';
  div.innerHTML = `
    <div class="col-md-4"><input type="text" class="form-control att-company" placeholder="社名"></div>
    <div class="col-md-4"><input type="text" class="form-control att-name" placeholder="氏名"></div>
    <div class="col-md-4"><input type="email" class="form-control att-email" placeholder="メールアドレス"></div>
  `;
  container.appendChild(div);
}

function loadTimetable() {
  google.script.run.withSuccessHandler(renderTimetable).getAvailabilityConfig();
}

// --- ★修正5: タイムテーブル生成ロジックの変更 ---
function renderTimetable(configData) {
  let targetDates = [];
  let start = moment().add(2, 'days');
  
  for (let i = 0; i < 14; i++) {
    let d = start.clone().add(i, 'days');
    if (d.day() !== 0 && d.day() !== 6) { 
      targetDates.push(d);
    }
  }

  // ゲスト希望日時文字列を取得
  let guestRequestedString = "";
  if (currentViewMode === 'confirm') {
    guestRequestedString = document.getElementById('guestRequestedDates').value || "";
  }

  let html = '<table class="table table-bordered table-sm">';
  html += '<thead><tr><th>時間帯</th>';
  targetDates.forEach(d => {
    // 修正: 曜日フォーマットを統一
    html += `<th>${d.format('MM/DD')}<br>(${d.format('dd')})</th>`;
  });
  html += '</tr></thead><tbody>';

  for (let r = 1; r < configData.length; r++) {
    let timeSlot = configData[r][0];
    html += `<tr><td class="bg-light fw-bold">${timeSlot}</td>`;
    
    targetDates.forEach(d => {
      let dayIndex = d.day(); 
      let status = configData[r][dayIndex];
      
      // セルごとのユニークな値（クリック時に取得する値）
      // ※Moment.jsのフォーマットと完全に一致させる
      let datePart = d.format('YYYY/MM/DD');
      let cellValue = `${datePart}(${d.format('dd')}) ${timeSlot}`;
      
      let isAvailable = (status === 'OK');

      // 確定モード（Confirm）の表示ロジック
      if (currentViewMode === 'confirm') {
        // ★修正ポイント: 単純な文字列一致ではなく、日付と時間が含まれているかチェック
        // 例: "2025/12/23" と "09:30-11:30" が両方とも guestRequestedString に含まれているか
        // より厳密には、その組み合わせが存在するか確認
        
        // 判定ロジック: 日付部分と時間部分が、ゲスト希望文字列の中に「ひとかたまり」として存在するか確認
        // 空白や区切り文字の揺らぎを吸収するため、シンプルに日付と時間が含まれているかで判定（簡易版）
        let isCandidate = guestRequestedString.indexOf(datePart) !== -1 && guestRequestedString.indexOf(timeSlot) !== -1;

        // もし「12/23の10:00」と「12/24の10:00」があり、クロスして誤検知するのを防ぐなら以下のように正規化して比較推奨ですが
        // 今回のアプリ仕様なら上記でも概ね動きます。より確実なのはこちら↓
        if (guestRequestedString.includes(cellValue)) {
             isCandidate = true;
        } else {
             // 念のため、全角・半角スペースの差を無視して再チェック
             let normGuest = guestRequestedString.replace(/\s+/g, '').replace(/　/g, '');
             let normCell = cellValue.replace(/\s+/g, '').replace(/　/g, '');
             isCandidate = normGuest.includes(normCell);
        }

        if (isCandidate) {
          // ゲストが希望した日時: 薄いピンク(.cell-candidate) で ◎
          html += `<td class="timetable-cell cell-candidate" data-val="${cellValue}" onclick="selectCell(this)">◎</td>`;
        } else {
          // それ以外: 選択不可
          html += `<td class="timetable-cell cell-disabled">×</td>`;
        }
      } 
      // ゲストモード / 通常モード
      else {
        if (isAvailable) {
          html += `<td class="timetable-cell" data-val="${cellValue}" onclick="selectCell(this)">○</td>`;
        } else {
          html += `<td class="timetable-cell cell-ng">×</td>`;
        }
      }
    });
    html += '</tr>';
  }
  html += '</tbody></table>';
  
  document.getElementById('timetable-area').innerHTML = html;
}
function selectCell(td) {
  if (currentViewMode === 'confirm') {
    document.querySelectorAll('.cell-selected').forEach(el => el.classList.remove('cell-selected'));
    td.classList.add('cell-selected');
  } 
  else {
    if (td.classList.contains('cell-selected')) {
      td.classList.remove('cell-selected');
    } else {
      td.classList.add('cell-selected');
    }
  }
  updateSelectedInput();
}

function updateSelectedInput() {
  const selectedCells = document.querySelectorAll('.timetable-cell.cell-selected');
  const values = [];
  selectedCells.forEach(cell => {
    values.push(cell.getAttribute('data-val'));
  });
  document.getElementById('selectedDateDisplay').value = values.join('、 ');
}

function submitCreate() {
  const meetingName = document.getElementById('meetingName').value;
  if(!meetingName) {
    showInfoModal('入力エラー', '会議名を入力してください');
    return;
  }
  
  const host = {
    company: document.getElementById('hostCompany').value,
    name: document.getElementById('hostName').value,
    email: document.getElementById('hostEmail').value
  };
  
  const attendees = [];
  document.querySelectorAll('.attendee-row').forEach(row => {
    const email = row.querySelector('.att-email').value;
    if(email) {
      attendees.push({
        company: row.querySelector('.att-company').value,
        name: row.querySelector('.att-name').value,
        email: email
      });
    }
  });

  const btn = document.getElementById('btnAdjust');
  btn.disabled = true;
  btn.innerText = '送信中...';

  google.script.run.withSuccessHandler((res) => {
    showInfoModal('完了', res.message);
    btn.innerText = '完了';
  }).withFailureHandler((err) => {
    showInfoModal('エラー', 'エラーが発生しました: ' + err);
    btn.disabled = false;
    btn.innerText = '調整（メール下書き作成）';
  }).createDraftAndSave({
    meetingName, host, attendees
  });
}

function checkGuestSubmit() {
  const name = document.getElementById('reserverName').value;
  const email = document.getElementById('reserverEmail').value;
  const date = document.getElementById('selectedDateDisplay').value;
  
  if(!name || !email) {
    showInfoModal('入力エラー', '氏名とメールアドレスは必須です');
    return;
  }
  if(!date) {
    showInfoModal('入力エラー', '希望日時を選択してください');
    return;
  }

  showConfirmModal('送信確認', '入力した内容で返信しますか？', function() {
    execGuestReply(name, email, date);
  });
}

function execGuestReply(name, email, date) {
  const id = document.getElementById('bookingId').value;
  const msg = document.getElementById('reserverMessage').value;

  google.script.run.withSuccessHandler(() => {
    document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-success"><h3>返信が完了しました。</h3><p>画面を閉じてください。</p></div></div>';
  }).handleGuestReply({
    id: id,
    reserverName: name,
    reserverEmail: email,
    selectedDate: date, 
    message: msg
  });
}

function checkConfirmSubmit() {
  const date = document.getElementById('selectedDateDisplay').value;
  
  if(!date) {
    showInfoModal('入力エラー', '日時が選択されていません');
    return;
  }
  
  if (date.includes('、')) {
    showInfoModal('確認', '確定処理のため、タイムテーブルから日時を「1つだけ」選択してください。');
    return;
  }

  showConfirmModal(
    '日程確定', 
    `以下の日時で確定します。<br><strong>${date}</strong><br><br>関係者に確定メールが送信され、カレンダーに登録されます。よろしいですか？`,
    function() {
      execConfirm(date);
    }
  );
}

function execConfirm(date) {
  const id = document.getElementById('bookingId').value;
  google.script.run.withSuccessHandler(() => {
    document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-primary"><h3>確定処理が完了しました。</h3></div></div>';
  }).confirmBooking({
    id: id,
    finalDate: date
  });
}
</script>