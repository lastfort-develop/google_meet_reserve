<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .logo { height: 50px; width: auto; margin-bottom: 0; }
      
      .timetable-cell { cursor: pointer; text-align: center; }
      .timetable-cell:hover { background-color: #e9ecef; }
      
      /* 選択状態 */
      .cell-selected { background-color: #0d6efd !important; color: white; }
      
      /* NG または 選択不可 */
      .cell-ng { background-color: #f8d7da; color: #842029; cursor: not-allowed; }
      
      /* 主催者モードで、ゲストが選んでいない日時 */
      .cell-disabled { background-color: #e2e3e5; color: #6c757d; cursor: not-allowed; opacity: 0.6; }
    </style>
  </head>
  <body>
    <div class="container mt-4 mb-5">
      <div class="d-flex align-items-center mb-4">
        <img src="https://drive.google.com/thumbnail?id=1nBQRHL054u4Jp00oZHUJLSk7MKcx3fld&sz=w200" class="logo me-3">
        <h2>会議調整アプリ</h2>
      </div>

      <? if (viewMode === 'create') { ?>
        <div id="create-view">
          <div class="card p-4">
            <h4>会議新規作成</h4>
            <div class="mb-3">
              <label class="form-label">会議の議題（会議名）</label>
              <input type="text" id="meetingName" class="form-control" placeholder="例: システム開発定例">
            </div>

            <div class="row mb-3">
              <h5>主催者情報</h5>
              <div class="col-md-4">
                <input type="text" id="hostCompany" class="form-control" placeholder="社名">
              </div>
              <div class="col-md-4">
                <input type="text" id="hostName" class="form-control" placeholder="氏名">
              </div>
              <div class="col-md-4">
                <input type="email" id="hostEmail" class="form-control" placeholder="メールアドレス">
              </div>
            </div>

            <div class="mb-3">
              <h5>出席者情報 <button type="button" class="btn btn-sm btn-outline-primary" onclick="addAttendeeRow()">＋</button></h5>
              <div id="attendees-container">
                <div class="row mb-2 attendee-row">
                  <div class="col-md-4"><input type="text" class="form-control att-company" placeholder="社名"></div>
                  <div class="col-md-4"><input type="text" class="form-control att-name" placeholder="氏名"></div>
                  <div class="col-md-4"><input type="email" class="form-control att-email" placeholder="メールアドレス"></div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <button id="btnAdjust" class="btn btn-primary" onclick="submitCreate()">調整（メール下書き作成）</button>
              <button class="btn btn-secondary" disabled>返信</button>
              <button class="btn btn-secondary" disabled>確定</button>
            </div>
          </div>
        </div>

      <? } else if (viewMode === 'guest' || viewMode === 'confirm') { ?>
        <div id="guest-view">
          <div class="card p-4">
            <h4><?= bookingData.meetingName ?></h4>
            <p>主催者: <?= bookingData.host.company ?> <?= bookingData.host.name ?></p>
            <p>状態: <strong><?= bookingData.status ?></strong></p>

            <hr>
            <h5>日程選択</h5>
            <? if (viewMode === 'confirm') { ?>
                <div class="alert alert-info">
                  ゲスト希望日時: <strong><?= bookingData.status === '相手返信済' ? bookingData.confirmedDate : 'なし' ?></strong><br>
                  上記の中から日時を1つ選択して「確定」してください。
                </div>
            <? } else { ?>
                <p>明後日から2週間の空き状況（複数選択可）</p>
            <? } ?>

            <div id="timetable-area" class="table-responsive mb-4">
              Loading timetable...
            </div>

            <div class="mb-3">
              <label>選択された日時:</label>
              <input type="text" id="selectedDateDisplay" class="form-control" readonly 
                     value="<?= (viewMode === 'confirm' && bookingData.status === '予約確定') ? bookingData.confirmedDate : '' ?>">
            </div>

            <div class="mb-3">
              <label class="form-label">予約者氏名 <span class="badge bg-danger">必須</span></label>
              <input type="text" id="reserverName" class="form-control" value="<?= bookingData.reserverName || '' ?>">
            </div>
            <div class="mb-3">
              <label class="form-label">予約者メールアドレス <span class="badge bg-danger">必須</span></label>
              <input type="email" id="reserverEmail" class="form-control" value="<?= bookingData.reserverEmail || '' ?>">
            </div>
            <div class="mb-3">
              <label class="form-label">メッセージ（任意）</label>
              <textarea id="reserverMessage" class="form-control" rows="3"></textarea>
            </div>

            <div class="mt-4">
              <? if (viewMode === 'guest') { ?>
                <button class="btn btn-success" onclick="checkGuestSubmit()">返信（日程希望の連絡）</button>
                <button class="btn btn-secondary" disabled>確定</button>
              <? } else { ?>
                <button class="btn btn-secondary" disabled>返信</button>
                <button class="btn btn-primary" onclick="checkConfirmSubmit()" <?= bookingData.status !== '相手返信済' ? 'disabled' : '' ?>>確定（日時決定）</button>
              <? } ?>
            </div>
          </div>
        </div>
      <? } ?>
    </div>

    <input type="hidden" id="bookingId" value="<?= bookingData ? bookingData.id : '' ?>">
    <input type="hidden" id="guestRequestedDates" value="<?= (bookingData && bookingData.status === '相手返信済') ? bookingData.confirmedDate : '' ?>">

    <div class="modal fade" id="msgModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="msgModalTitle">確認</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="msgModalBody">
            メッセージ
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="msgModalCancel">キャンセル</button>
            <button type="button" class="btn btn-primary" id="msgModalOK">OK</button>
          </div>
        </div>
      </div>
    </div>

    <?!= include('javascript'); ?>
  </body>
</html>